<style>
    .my-custom-scrollbar {
        position: relative;
        height: 100%;
        overflow: auto;
    }
    .table-wrapper-scroll-y {
        display: block;
    }
</style>

<div id="widget-panelChat" class="table-wrapper-scroll-y my-custom-scrollbar">
    <h4>Mensajes</h4>
    <table id="scrollableTable" class="table table-bordered table-striped mb-0">
        <tbody id="conversation">
        <tr>
            <td>Tiger Nixon</td>
            <td>System Architect</td>
        </tr>
        <tr>
            <td>Tiger Nixon</td>
            <td>System Architect</td>
        </tr>
        <tr>
            <td>Tiger Nixon</td>
            <td>System Architect</td>
        </tr>
    </table>
    <div class="form-group">
        <label for="textArea-mensaje">Nuevo mensaje:</label>
        <textarea class="form-control rounded-0" id="textArea-mensaje" rows="3"></textarea>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-5 col-sm-10">
            <button class="btn btn-primary" type="button" id="btn-crear-mensaje">Enviar</button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $("#btn-crear-mensaje").click(function () {
            clearNotifications();
            if ($("#textArea-mensaje").val() == "") {
                showNotification("Por favor, escribe un mensaje.");
            } else {
                $.ajax(
                    {
                        url : URLbase + "/mensaje/crear",
                        type : "POST",
                        data : {
                            destino : destino,
                            texto : $("#textArea-mensaje").val()
                        },
                        dataType : "json",
                        headers: { "token": token },
                        success : function (res) {
                            updateChat(destino);
                        },
                        error : function (error) {
                            showNotification(error, "alert alert-danger");
                        }
                    }
                )
            }
        });
    });

    var messages = [];
    function updateChat(friendEmail) {
        destino = friendEmail;
        $.ajax(
            {
                url : URLbase + "/mensaje/ver/" + destino,
                type : "GET",
                data: { },
                dataType: 'json',
                headers: { "token": token },
                success : function (res) {
                    messages = JSON.parse(res);
                    updateView();
                },
                error : function (error) {
                    showNotification(error, "alert alert-danger");
                }
            }
        )
    }
    
    function updateView() {
        console.log(messages);

        let myNode = document.getElementById("conversation");
        while (myNode.firstChild) {
            myNode.removeChild(myNode.lastChild);
        }

        for (i = 0; i < messages.length; i++) {
            if (messages[i].emisor == email) {
                $("#conversation").append(
                    "<tr>" +
                    "<td></td>" +
                    "<td>"+messages[i].texto+"</td>" +
                    "</tr>"
                );
            } else {
                $("#conversation").append(
                    "<tr>" +
                    "<td>"+messages[i].texto+"</td>" +
                    "<td></td>" +
                    "</tr>"
                );
            }
        }
    }
</script>

